<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/106/three.min.js"></script>
    <script type="text/javascript" src="rooms.js"></script>
</head>
<body>
<div style="position:absolute;top:0px;">
    <canvas id="canvas" style="display: block;"></canvas>
</div>
<div style="position:absolute;bottom:0px;">
    by maksim.vladimirovich (evaluation rocks!)
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 style="color:white;">Lzd Room Finder</h2>
        </div>
    </div>
    <div class="row">
        <div class="col-9">
            <select autofocus="autofocus" class="form-control" id="slctRoom" onchange="lookAtName()">
                <option value="">--select room (sorted a-z) --</option>
                <option value="Aphrodite">Aphrodite - 19F</option>
                <option value="Apollo">Apollo - 19F</option>
                <option value="Ares">Ares - 19F</option>
                <option value="Athena">Athena - 20F</option>
                <option value="Artemis">Artemis - 19F</option>
                <option value="Demeter">Demeter - 20F</option>
                <option value="Eros">Eros - 19F</option>
                <option value="Hades">Hades - 19F</option>
                <option value="Hebe">Hebe - 19F</option>
                <option value="Helios">Helios - 19F</option>
                <option value="Hera">Hera - 19F</option>
                <option value="Heracles">Heracles - 19F</option>
                <option value="Hermes">Hermes - 19F</option>
                <option value="Hermione">Hermione - 20F</option>
                <option value="Iris">Iris - 19F</option>
                <option value="Morpheus">Morpheus - 19F</option>
                <option value="Metis">Metis - 19F</option>
                <option value="Nike">Nike - 19F</option>
                <option value="Odysseus">Odysseus - 20F</option>
                <option value="Orion">Orion - 20F</option>
                <option value="Pandora">Pandora - 20F</option>
                <option value="Phoebe">Phoebe - 20F</option>
                <option value="Phoenix">Phoenix - 20F</option>
                <option value="Poseidon">Poseidon - 19F</option>
                <option value="Roma">Roma - 20F</option>
                <option value="Selene">Selene - 19F</option>
                <option value="Uranus">Uranus - 19F</option>
                <option value="Zeus">Zeus - 20F</option>
            </select>
        </div>
        <div class="col-3">
            <button class="btn btn-danger" id="btnReset" onclick="resetSearch()">Reset</button>
        </div>
    </div>
    <br/>
    <div class="row">
        <div class="col">
            <h2 style="color:white;" id="floorSelect">Floor: 20</h2><h6 id="reception" style="color:white"></h6>
        </div>
        <div class="col">
            <button id="btn19" class="btn btn-info" onclick="goFloor(19)">19</button>
            <button id="btn20" class="btn btn-info" onclick="goFloor(20)">20</button>
        </div>
    </div>
</div>

<script>
    'use strict';
    /* global THREE */
    var camera, scene, renderer;
    var rooms = [];
    var floor = 20;

    function initCamera() {
        camera = new THREE.PerspectiveCamera(75, 1, 0.1, 2000);
        camera.rotation.set(0, Math.PI/8, Math.PI / 2);
        camera.position.z = 550;
        camera.position.x = 800;
        camera.position.y = -470;
    }

    function initScene() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color( 0x000000 );

        data.forEach(function (room) {
            if (room.floor == floor) {
                var roomObj = createRoom(room);
                rooms.push(roomObj);
                scene.add(roomObj);
            }
        });
        addReception();
        addLifts();
        addWalls();
    }

    function refresh() {
        renderer.render(scene, camera);
    }

    function addReception() {
        if(floor == 19) {
            var geometry = new THREE.BoxGeometry(10, 40, 40);
            var material = new THREE.MeshBasicMaterial({color: 0xff00ff00});
            var cube = new THREE.Mesh(geometry, material);
            cube.position.set(680, -470, 0);
            scene.add(cube);
        } else {
            var geometry = new THREE.RingGeometry( 8, 13, 32 );
            var yellowMat = new THREE.MeshBasicMaterial( { color: 0xffff00, side: THREE.DoubleSide } );
            var blueMat = new THREE.MeshBasicMaterial( { color: 0x0000ff, side: THREE.DoubleSide } );
            var greyMat = new THREE.MeshBasicMaterial( { color: 0xaaaaaa, side: THREE.DoubleSide } );
            var greenMat = new THREE.MeshBasicMaterial( { color: 0x00ff00, side: THREE.DoubleSide } );
            var redMat = new THREE.MeshBasicMaterial( { color: 0xff0000, side: THREE.DoubleSide } );

            var r1 = new THREE.Mesh( geometry, blueMat );
            r1.position.set(680,-400,20);
            scene.add( r1 );

            var r2 = new THREE.Mesh( geometry, yellowMat );
            r2.position.set(693,-387,20);
            scene.add( r2 );

            var r3 = new THREE.Mesh( geometry, greyMat);
            r3.position.set(680,-374,20);
            scene.add( r3 );

            var r4 = new THREE.Mesh( geometry, greenMat );
            r4.position.set(693,-361,20);
            scene.add( r4 );

            var r5 = new THREE.Mesh( geometry, redMat );
            r5.position.set(680,-348,20);
            scene.add( r5 );
/*
            var geometry = new THREE.BoxGeometry(10, 120, 40);
            var material = new THREE.MeshBasicMaterial({color: 0xff00ff00});
            var cube = new THREE.Mesh(geometry, material);
            cube.position.set(680, -400, 0);
            scene.add(cube);
*/
        }
    }

    function addLifts() {
        var shape = new THREE.Shape();
        shape.moveTo(
            lifts[0][0],
            -lifts[0][1]
        );

        for (var i = 1; i < lifts.length; i++) {
            shape.lineTo(
                lifts[i][0],
                -lifts[i][1]
            );
        }

        shape.lineTo(
            lifts[0][0],
            -lifts[0][1]
        );
        var liftGeo = new THREE.ExtrudeGeometry(shape, {depth: 10, bevelEnabled: false});
        var material = new THREE.MeshBasicMaterial({color: 0xff151515});  // grey
        var liftMesh = new THREE.Mesh(liftGeo, material);
        scene.add(liftMesh);
    }

    function addWalls() {
        var shape = new THREE.Shape();
        shape.moveTo(
            wall[0][0],
            -wall[0][1]
        );

        for (var i = 1; i < wall.length; i++) {
            shape.lineTo(
                wall[i][0],
                -wall[i][1]
            );
        }

        shape.lineTo(
            wall[0][0],
            -wall[0][1]
        );
        var wallGeo = new THREE.ExtrudeGeometry(shape, {depth: 0.1, bevelEnabled: false});
        var material = new THREE.MeshBasicMaterial({color: 0xff111111});  // grey
        var wallMesh = new THREE.Mesh(wallGeo, material);
        scene.add(wallMesh);
    }

    function createRoom(roomData) {
        var shape = new THREE.Shape();
        shape.moveTo(
            roomData.shape[0][0],
            -roomData.shape[0][1]
        );

        for (var i = 1; i < roomData.shape.length; i++) {
            shape.lineTo(
                roomData.shape[i][0],
                -roomData.shape[i][1]
            );
        }

        shape.lineTo(
            roomData.shape[0][0],
            -roomData.shape[0][1]
        );

        var roomGeo = new THREE.ExtrudeGeometry(shape, {depth: 20, bevelEnabled: false});
        var material = new THREE.MeshBasicMaterial({color: roomData.color});  // grey
        var room = new THREE.Mesh(roomGeo, material);
        room.callback = selectRoom;
        room.data = roomData;
        return room;
    }

    function selectRoom() {
        lookAtRoom(this.data);
        refresh();
    }

    function getFloor(name) {
        for (var i = 0; i < data.length; i++) {
            if (data[i].name == name) {
                return data[i].floor;
            }
        }
    }

    function lookAtName() {
        var name = document.getElementById("slctRoom").value;
        var roomFloor = getFloor(name);
        if (floor != roomFloor) {
            goFloor(roomFloor);
        }
        for (var i = 0; i < rooms.length; i++) {
            if (rooms[i].data.name == name) {
                lookAtRoom(rooms[i].data);
                return;
            }
        }
    }

    function goFloor(flr) {
        floor = flr;
        document.getElementById("floorSelect").innerHTML = "Floor: " + flr;
        if(flr == 19) {
            document.getElementById("reception").innerText = "(green = reception)";
        } else {
            document.getElementById("reception").innerText = "";
        }
        initScene();
        refresh();
    }

    function resetSearch() {
        document.getElementById("slctRoom").value = '';

        initCamera();
        initScene();
        renderer.render(scene, camera);
    }

    function lookAtRoom(roomData) {
        camera.position.set(1000, -500, 300);
        camera.up = new THREE.Vector3(0, 0, 1);
        if (roomData.lookFrom != null) {
            camera.position.x = roomData.lookFrom[0];
            camera.position.y = -roomData.lookFrom[1];
            camera.position.z = roomData.lookFrom[2];
        }
        if (roomData.lookAt != null) {
            camera.lookAt(roomData.lookAt[0], -roomData.lookAt[1], 0);
        } else {
            camera.lookAt(roomData.shape[0][0], -roomData.shape[0][1], 0);
        }

        for (var i = 0; i < rooms.length; i++) {
            if (rooms[i].data.name == roomData.name) {
                rooms[i].material.color.setHex(0xff990000);
            } else {
                rooms[i].material.color.setHex(rooms[i].data.color);
            }
        }

        refresh();
    }

    var lifts = [
        [268,287],
        [268,677],
        [540,677],
        [540,287]
    ];

    var wall = [
        [52,0],
        [774,0],
        [774,247],
        [772,247],
        [772,262],
        [781,262],
        //[781,260], window
        //[790,260], window
        [790,262],
        [826,262],
        [826,545],
        [772,545],
        [772,568],
        [774,568],
        [774,882],
        [52,882],
        [52,568],
        [54,568],
        [54,545],
        [1,545],
        [1,262],
        [54,262],
        [54,238],
        [52,238]
    ];

    (function () {

        var canvas = document.getElementById('canvas');
        // resize the canvas to fill browser window dynamically
        window.addEventListener('resize', resizeCanvas, false);
        window.addEventListener('load', init, false);

        //canvas.addEventListener('mousedown', clickRoom, false);

        function clickRoom(event) {
            var raycaster = new THREE.Raycaster();
            var mouse = new THREE.Vector2();
            event.preventDefault();

            mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            var intersects = raycaster.intersectObjects(rooms);

            if (intersects.length > 0) {
                intersects[0].object.callback();
            }
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initScene();
        }

        resizeCanvas();

        function init() {
            renderer = new THREE.WebGLRenderer({canvas});
            initCamera();
            initScene();
            renderer.render(scene, camera);
        }
    })();
</script>
</body>
</html>
